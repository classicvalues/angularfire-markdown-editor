/*! angularfire-markdown-editor - v0.0.0 - 2014-05-05
* https://github.com/hal9087/angularfire-markdown-editor
* Copyright (c) 2014 Ruben Barilani;
* Licensed MIT */
"use strict";function pathRef(a){for(var b=0;b<a.length;b++)"object"==typeof a[b]&&(a[b]=pathRef(a[b]));return a.join("/")}angular.module("myApp",["myApp.config","myApp.routes","myApp.filters","myApp.services","myApp.directives","myApp.controllers","waitForAuth","routeSecurity","ngSanitize","btford.markdown"]).config(["markdownConverterProvider",function(a){var b=function(){return[{type:"lang",regex:"([-]{4,})",replace:function(){return"<hr>"}}]};a.config({extensions:[b]})}]).run(["loginService","$rootScope","FBURL","$location","syncData","$route","sheetsService",function(a,b,c,d,e,f,g){"https://INSTANCE.firebaseio.com"===c?(angular.element(document.body).html("<h1>Please configure app/js/config.js before running!</h1>"),setTimeout(function(){angular.element(document.body).removeClass("hide")},250)):(b.auth=a.init("/login"),b.FBURL=c,b.$location=d,b.security={logout:function(){a.logout()}},b.$route=f,b.$on("$routeChangeSuccess",function(){if(null!=b.auth.user){var a=e(["users",b.auth.user.uid],1);a.$child("url").$set(d.url())}}),b.sheetsService=g,jQuery(window).bind("beforeunload",function(){if(null!=b.auth.user){var a=e(["users",b.auth.user.uid],1);a.$child("url").$set(null)}}))}]),angular.module("myApp.config",[]).constant("version","0.6").constant("loginRedirectPath","/signin").constant("FBURL","https://dazzling-fire-2143.firebaseio.com"),function(a){a.module("myApp.controllers",["myApp.controllers.sheets","myApp.controllers.users"])}(window.angular),function(a){var b=a.module("myApp.controllers.sheets",[]);b.controller("BaseSheetCtrl",["$scope","$routeParams","sheetsService","orderByPriorityFilter","$location",function(b,c,d,e,f){var g=this;g.sheetsService=d,g.$routeParams=c,g.orderByPriority=function(a){return e(a)},g.saveSheet=function(b,c){if(b.draft=c,a.isString(b.$id)){var d=g.sheetsService.oneByName(b.$id);a.extend(d,b),d.$save()}else g.sheetsService.createSheet(b);f.path("/sheets")},b.$saveSheet=function(a){g.saveSheet(a,!1)},b.$saveSheetLikeDraft=function(a){g.saveSheet(a,!0)}}]).controller("SheetNewSyncCtrl",["$scope","$controller",function(b,c){var d=this;a.extend(d,c("BaseSheetCtrl",{$scope:b})),d.sheetsService.createSheet(d.$routeParams.title).then(function(a){console.log(a),a.$bind(b,"sheet")})}]).controller("SheetNewCtrl",["$scope","$controller",function(b,c){var d=this;a.extend(d,c("BaseSheetCtrl",{$scope:b})),b.sheet=d.sheetsService.emptySheet("New sheet")}]).controller("SheetEditCtrl",["$scope","$controller",function(b,c){var d=this;a.extend(d,c("BaseSheetCtrl",{$scope:b})),a.isString(d.$routeParams.name)&&d.sheetsService.oneByName(d.$routeParams.name).$bind(b,"sheet")}]).controller("SheetCtrl",["$scope","$controller",function(b,c){var d=this;a.extend(d,c("SheetEditCtrl",{$scope:b}))}]).controller("SheetsListCtrl",["$scope","$controller",function(b,c){var d=this;a.extend(d,c("BaseSheetCtrl",{$scope:b})),b.sheets=d.sheetsService.sheets(),b.criteria={orderBy:"created",orderByReverse:!0},b.bug=!1,b.removeSheet=function(a){1===d.orderByPriority(b.sheets).length&&(b.bug=!0),b.sheets.$remove(a).then(function(){b.bug===!0&&(b.sheets=[],b.bug=!1)}).catch(function(a){console.error(a)})},b.lockSheet=function(b,c){if(a.isString(b)){var e=d.sheetsService.oneByName(b);e.lock=c,e.$save()}}}])}(window.angular),function(a){var b=a.module("myApp.controllers.users",[]);b.controller("UsersCtrl",["$scope","syncData",function(a,b){a.users=b("users")}]).controller("LoginCtrl",["$scope","loginService","$location",function(a,b,c){function d(){return a.email?a.pass?a.pass!==a.confirm&&(a.err="Passwords do not match"):a.err="Please enter a password":a.err="Please enter an email address",!a.err}a.username=null,a.email=null,a.pass=null,a.confirm=null,a.createMode=!1,a.login=function(c){a.err=null,a.email?a.pass?b.login(a.email,a.pass,function(b,d){a.err=b?b+"":null,b||c&&c(d)}):a.err="Please enter a password":a.err="Please enter an email address"},a.loginWith=function(c){b.loginWith(c,function(c,d){c?a.err=c?c+"":null:b.createProfile(d.uid,d.email,d.displayName)})},a.createAccount=function(){a.err=null,d()&&b.createAccount(a.email,a.pass,function(d,e){d?a.err=d?d+"":null:a.login(function(){b.createProfile(e.uid,e.email,a.username),c.path("/account")})})}}]).controller("AccountCtrl",["$scope","loginService","syncData",function(a,b,c){function d(){return{email:a.auth.user.email,oldpass:a.oldpass,newpass:a.newpass,confirm:a.confirm,callback:function(b){b?a.err=b:(a.oldpass=null,a.newpass=null,a.confirm=null,a.msg="Password updated!")}}}c(["users",a.auth.user.uid]).$bind(a,"user"),a.logout=function(){b.logout()},a.oldpass=null,a.newpass=null,a.confirm=null,a.reset=function(){a.err=null,a.msg=null},a.updatePassword=function(){a.reset(),b.changePassword(d())}}])}(window.angular),function(a){var b=a.module("myApp.directives",["angular-md5"]);b.directive("appVersion",["version",function(a){return function(b,c){c.text(a)}}]),b.directive("pageHeader",[function(){var a='<div class="page-header"><h1 ng-transclude></h1></div>';return{restrict:"EA",replace:!0,transclude:!0,template:a}}]),b.directive("gravatar",["md5",function(b){return{restrict:"EA",replace:!0,scope:{email:"=gravatar"},controller:["$scope",function(c){c.hash="none",c.$watch("email",function(d){a.isString(d)&&(c.hash=b.createHash(d))})}],template:'<a class="thumbnail"><img ng-src="http://www.gravatar.com/avatar/{{ hash }}"></a>'}}]),b.directive("sheetRow",function(){return{restrict:"EA",replace:!0,templateUrl:"templates/sheetRow.html"}}),b.directive("markdownEditor",function(){return{restrict:"EA",controller:["$scope",function(a){a.editor={mode:"preview",phase:{preview:!1}}}]}}),b.directive("youEmail",["$rootScope",function(b){function c(a){a.you=a.youEmail===b.auth.user.email?d:a.youEmail}var d="You ❤";return{restrict:"EA",replace:!1,scope:{youEmail:"="},link:function(b){c(b),b.$watch("youEmail",function(d,e){a.isString(d)&&d!=e&&c(b)})},template:"{{ you }}"}}]),b.directive("insertAtCursor",["$parse",function(b){function c(a,b,c){if(a.selectionStart||"0"==a.selectionStart){var d=a.selectionStart,e=a.selectionEnd;b=b.substring(0,d)+c+b.substring(e,a.value.length),a.selectionStart=d+c.length,a.selectionEnd=d+c.length}else b+=c;return b}return{restrict:"EA",controller:["$scope","$attrs",function(d,e){d.$insertAtCursor=function(f,g){var h=b(e.ngModel)(d),i=a.element(f);return i.focus(),c(i,h," "+g)}}]}}])}(window.angular),angular.module("myApp.filters",[]).filter("interpolate",["version",function(a){return function(b){return String(b).replace(/\%VERSION\%/gm,a)}}]).filter("reverse",function(){function a(a){var b,c=[];if(a)if(angular.isArray(a))c=a;else if("object"==typeof a)for(b in a)a.hasOwnProperty(b)&&c.push(a[b]);return c}return function(b){return a(b).slice().reverse()}}).filter("connectedUsers",function(){var a=[];return function(b){return _.isArray(b)&&(a=_.filter(b,function(a){return _.isString(a.url)})),a}}).filter("draftSheets",function(){var a=[];return function(b,c){return _.isArray(b)&&(a=_.filter(b,function(a){return c===!1?1!=a.draft&&-1==a.title.indexOf("Untitled"):a.draft===!0||_.isString(a.title)&&(c===!1?-1==a.title.indexOf("Untitled"):-1!=a.title.indexOf("Untitled"))})),a}}),angular.module("myApp.routes",["ngRoute"]).config(["$routeProvider",function(a){a.when("/home",{templateUrl:"partials/home.html"}),a.when("/signin",{templateUrl:"partials/signin.html",controller:"LoginCtrl"}),a.when("/account",{authRequired:!0,templateUrl:"partials/account.html",controller:"AccountCtrl"}),a.when("/editor/new-sync/:title",{authRequired:!0,templateUrl:"partials/editor.html",controller:"SheetNewSyncCtrl"}),a.when("/editor/new",{authRequired:!0,templateUrl:"partials/editor.html",controller:"SheetNewCtrl"}),a.when("/editor/:name",{authRequired:!0,templateUrl:"partials/editor.html",controller:"SheetEditCtrl"}),a.when("/sheets",{authRequired:!0,templateUrl:"partials/sheets.html",controller:"SheetsListCtrl"}),a.when("/sheet/:name",{authRequired:!0,templateUrl:"partials/sheet.html",controller:"SheetCtrl"}),a.otherwise({redirectTo:"/home"})}]),function(){angular.module("myApp.services",["myApp.service.login","myApp.service.firebase"]).factory("sheetsService",["$rootScope","$firebase","firebaseRef","syncData",function(a,b,c,d){function e(b){if(null===a.auth.user)throw new Error('Must be a $rootScope.auth.user before using this method : "'+b+'"')}var f="sheets";return{emptySheet:function(b,c,d){e("emptySheet");var f=this;return{title:b||f.randomTitle(),body:c||"# Hi man!",author:a.auth.user.email,created:new Date,draft:angular.isDefined(d)?d:!0}},createSheet:function(a,c,d){e("createSheet");var f,g=this;return f=angular.isString(a)?g.emptySheet(a,c,d):angular.isObject(a)?angular.extend(g.emptySheet(void 0,c,d),a):g.emptySheet(a,c,d),g.sheets().$add(f).then(function(a){return b(a)})},oneByName:function(a){return b(c(f,a))},randomTitle:function(b){if(e("randomTitle"),b===!1)return"Untitled-"+(null===a.auth.user?"Unknown":a.auth.user.email);var c=(new Date).getTime(),d="Untitled-"+c+"-"+(null===a.auth.user?"Unknown":a.auth.user.email);return d},sheets:function(){return d(f)}}}])}(),angular.module("myApp.service.login",["firebase","myApp.service.firebase"]).factory("loginService",["$rootScope","$firebaseSimpleLogin","firebaseRef","profileCreator","$timeout","syncData",function(a,b,c,d,e,f){function g(){if(null===h)throw new Error("Must call loginService.init() before using its methods")}var h=null;return{init:function(){return h=b(c())},login:function(a,b,c){g(),h.$login("password",{email:a,password:b,rememberMe:!0}).then(function(a){c&&e(function(){c(null,a)})},c)},loginWith:function(a,b){g(),h.$login(a).then(function(a){b&&e(function(){b(null,a)})},b)},logout:function(){g();var a=f(["users",h.user.uid],1);a.$child("url").$set(null),h.$logout()},changePassword:function(a){g();var b=a.callback||function(){};a.oldpass&&a.newpass?a.newpass!==a.confirm?e(function(){b("Passwords do not match")}):h.$changePassword(a.email,a.oldpass,a.newpass).then(function(){b&&b(null)},b):e(function(){b("Please enter a password")})},createAccount:function(a,b,c){g(),h.$createUser(a,b).then(function(a){c&&c(null,a)},c)},createProfile:d}}]).factory("profileCreator",["firebaseRef","$timeout",function(a,b){return function(c,d,e,f){function g(a){return h(a.substr(0,a.indexOf("@"))||"")}function h(a){a+="";var b=a.charAt(0).toUpperCase();return b+a.substr(1)}var i=a("users/"+c);i.child("email").once("value",function(a){var c=null!==a.val();c===!1&&(console.info("user does not exists, create a user profile!"),i.set({email:d,username:e||g(d)},function(a){f&&b(function(){f(a)})}))})}}]),angular.module("myApp.service.firebase",["firebase"]).factory("firebaseRef",["Firebase","FBURL",function(a,b){return function(){return new a(pathRef([b].concat(Array.prototype.slice.call(arguments))))}}]).service("syncData",["$firebase","firebaseRef",function(a,b){return function(c,d){var e=b(c);return d&&(e=e.limit(d)),a(e)}}]),angular.module("waitForAuth",[]).service("waitForAuth",["$rootScope","$q","$timeout",function(a,b,c){function d(b){a.auth&&(a.auth.error=b instanceof Error?b.toString():null);for(var d=0;d<f.length;d++)f[d]();c(function(){e.resolve()})}var e=b.defer(),f=[];return f.push(a.$on("$firebaseSimpleLogin:login",d)),f.push(a.$on("$firebaseSimpleLogin:logout",d)),f.push(a.$on("$firebaseSimpleLogin:error",d)),e.promise}]).directive("ngCloakAuth",["waitForAuth",function(a){return{restrict:"A",compile:function(b){b.addClass("hide"),a.then(function(){b.removeClass("hide")})}}}]).directive("ngShowAuth",["$rootScope",function(a){function b(a,b){var c=!1;return angular.forEach(b,function(b){return b===a?(c=!0,!0):!1}),c}function c(a){if(!a)throw new Error("ng-show-auth directive must be login, logout, or error (you may use a comma-separated list)");var c=(a||"").split(",");return angular.forEach(c,function(a){if(!b(a,["login","logout","error"]))throw new Error('Invalid state "'+a+'" for ng-show-auth directive, must be one of login, logout, or error')}),!0}var d;return a.$on("$firebaseSimpleLogin:login",function(){d="login"}),a.$on("$firebaseSimpleLogin:logout",function(){d="logout"}),a.$on("$firebaseSimpleLogin:error",function(){d="error"}),{restrict:"A",compile:function(e,f){function g(a){d=a;var c=!b(a,h);e.toggleClass("hide",c)}c(f.ngShowAuth);var h=(f.ngShowAuth||"").split(",");g(d),a.$on("$firebaseSimpleLogin:login",function(){g("login")}),a.$on("$firebaseSimpleLogin:logout",function(){g("logout")}),a.$on("$firebaseSimpleLogin:error",function(){g("error")})}}}]),function(a){function b(a,b,c,d){this._route=c,this._location=a,this._rootScope=b,this._loginPath=d,this._redirectTo=null,this._authenticated=!(!b.auth||!b.auth.user),this._init()}a.module("routeSecurity",[]).run(["$injector","$location","$rootScope","loginRedirectPath",function(a,c,d,e){a.has("$route")&&new b(c,d,a.get("$route"),e)}]),b.prototype={_init:function(){var b=this;this._checkCurrent(),b._rootScope.$on("$routeChangeStart",function(a,c){b._authRequiredRedirect(c,b._loginPath)}),b._rootScope.$on("$firebaseSimpleLogin:login",a.bind(this,this._login)),b._rootScope.$on("$firebaseSimpleLogin:logout",a.bind(this,this._logout)),b._rootScope.$on("$firebaseSimpleLogin:error",a.bind(this,this._error))},_checkCurrent:function(){this._route.current&&this._authRequiredRedirect(this._route.current,this._loginPath)},_login:function(){this._authenticated=!0,this._redirectTo?(this._redirect(this._redirectTo),this._redirectTo=null):this._location.path()===this._loginPath&&(this._location.replace(),this._location.path("/"))},_logout:function(){this._authenticated=!1,this._checkCurrent()},_error:function(){this._rootScope.auth&&this._rootScope.auth.user||(this._authenticated=!1),this._checkCurrent()},_redirect:function(a){this._location.replace(),this._location.path(a)},_authRequiredRedirect:function(a,b){a.authRequired&&!this._authenticated?(this._redirectTo=void 0===a.pathTo?this._location.path():a.pathTo===b?"/":a.pathTo,this._redirect(b)):this._authenticated&&this._location.path()===this._loginPath&&this._redirect("/")}}}(angular);